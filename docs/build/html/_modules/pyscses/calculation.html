

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyscses.calculation &mdash; Python  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Python  documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Python
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">API documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">pyscses</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Python</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pyscses.calculation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyscses.calculation</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="kn">from</span> <span class="nn">sympy</span> <span class="k">import</span> <span class="n">mpmath</span>
<span class="kn">from</span> <span class="nn">bisect</span> <span class="k">import</span> <span class="n">bisect_left</span><span class="p">,</span> <span class="n">bisect_right</span>
<span class="kn">from</span> <span class="nn">pyscses.set_of_sites</span> <span class="k">import</span> <span class="n">Set_of_Sites</span>
<span class="kn">from</span> <span class="nn">pyscses.matrix_solver</span> <span class="k">import</span> <span class="n">MatrixSolver</span>
<span class="kn">from</span> <span class="nn">pyscses.set_up_calculation</span> <span class="k">import</span> <span class="n">calculate_grid_offsets</span>
<span class="kn">from</span> <span class="nn">pyscses.constants</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyscses.grid</span> <span class="k">import</span> <span class="n">delta_x_from_grid</span><span class="p">,</span> <span class="n">Grid</span><span class="p">,</span> <span class="n">phi_at_x</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">minimize</span>

<div class="viewcode-block" id="Calculation"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.Calculation">[docs]</a><span class="k">class</span> <span class="nc">Calculation</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Calculation class contains all of the functions required to calculate all of the relevant space charge properties for any given system, such as electrostatic potential, charge density, defect mole fractions and parallel and perpendicular grain boundary resistivities. </span>
<span class="sd">    Args:</span>
<span class="sd">        grid (object): Grid object - contains properties of the grid including the x coordinates and the volumes.</span>
<span class="sd">        bulk_x_min (float): The minimum x coordinate defining a region of bulk.</span>
<span class="sd">        bulk_x_max (float): The maximum x coordinate defining a region of bulk.</span>
<span class="sd">        alpha (float): A damping parameter for updating the potential at each iteration.</span>
<span class="sd">        convergence (float): The convergence limit. The difference between the updated phi and the phi from the previous iteration must be below this for the calculation to be sufficently converged. </span>
<span class="sd">        dielectric (float): The dielectric constant for the studied material.</span>
<span class="sd">        temp (float): The temperature that the calculation is run. </span>
<span class="sd">        boundary_conditions(str): Specified boundary conditions for the matrix solver. Allowed values are `dirichlet` and `periodic`. Default = `dirichlet`.</span>
<span class="sd"> </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">bulk_x_min</span><span class="p">,</span> <span class="n">bulk_x_max</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">convergence</span><span class="p">,</span> <span class="n">dielectric</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">boundary_conditions</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_x_min</span> <span class="o">=</span> <span class="n">bulk_x_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_x_max</span> <span class="o">=</span> <span class="n">bulk_x_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="o">=</span> <span class="n">convergence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dielectric</span> <span class="o">=</span> <span class="n">dielectric</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_conditions</span> <span class="o">=</span> <span class="n">boundary_conditions</span>


<div class="viewcode-block" id="Calculation.mole_fraction_error"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.Calculation.mole_fraction_error">[docs]</a>    <span class="k">def</span> <span class="nf">mole_fraction_error</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">input_mole_fractions</span><span class="p">,</span> <span class="n">target_mole_fractions</span><span class="p">,</span> <span class="n">approximation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the sum of sqaures error between the output mole fractions calculated from the input mole fractions, compared to the target mole fractions.</span>
<span class="sd">        Args:</span>
<span class="sd">            input_mole_fractions( list ): Mole fractions for each of the species used in the iterative Poisson-Boltzmann solver.</span>
<span class="sd">            target_mole_fractions( list ): The value that the mole fractions should be in the bulk. </span>

<span class="sd">        Returns:</span>
<span class="sd">            Sum of squares error between output and target mole fractions. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">input_mole_fractions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">input_mole_fractions</span><span class="p">])</span>
        <span class="n">output_mole_fractions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mole_fraction_output</span><span class="p">(</span><span class="n">input_mole_fractions</span><span class="p">,</span> <span class="n">approximation</span><span class="p">)</span>
        <span class="n">squares</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="n">input_mole_fractions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf</span><span class="p">)):</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">output_mole_fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">target_mole_fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
                <span class="n">squares</span><span class="o">.</span><span class="n">append</span><span class="p">((</span> <span class="n">output</span> <span class="o">-</span> <span class="n">target</span> <span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">squares</span> <span class="p">)</span>

<div class="viewcode-block" id="Calculation.mole_fraction_output"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.Calculation.mole_fraction_output">[docs]</a>    <span class="k">def</span> <span class="nf">mole_fraction_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_mole_fractions</span><span class="p">,</span> <span class="n">approximation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the output mole fraction for a given input mole fraction when solving the Poisson-Boltzmann equation.</span>
<span class="sd">        Args:</span>
<span class="sd">            input_mole_fractions( list ): Mole fractions for each of the species used in the iterative Poisson-Boltzmann solver.</span>
<span class="sd">   </span>
<span class="sd">        Returns:</span>
<span class="sd">            output_mole_fractions( list ): Mole fractions that are calculated from the iterative Poisson-Boltzmann solver.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="n">input_mole_fractions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">set_of_sites</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">):</span>
                    <span class="k">for</span> <span class="n">defect</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">defect_species</span><span class="p">:</span>
                        <span class="n">defect</span><span class="o">.</span><span class="n">mole_fraction</span> <span class="o">=</span> <span class="n">input_mole_fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">defect</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">defects</span><span class="p">:</span>
                        <span class="n">defect</span><span class="o">.</span><span class="n">mole_fraction</span> <span class="o">=</span> <span class="n">input_mole_fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span> <span class="n">approximation</span> <span class="p">)</span>
        <span class="n">species</span> <span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="n">input_mole_fractions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf</span><span class="p">)):</span>
                <span class="n">species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site_labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form_subgrids</span><span class="p">(</span> <span class="n">species</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mole_fractions</span><span class="p">()</span>
        <span class="n">average_mole_fractions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="n">input_mole_fractions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">site_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mf</span> <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">site_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">if</span> <span class="n">mf</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="p">]</span>
                <span class="n">average_mf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subgrids</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">site_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_x_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_x_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">site_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
                <span class="n">average_mole_fractions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">average_mf</span><span class="p">)</span> 
        <span class="n">output_mole_fractions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span> <span class="n">average_mole_fractions</span> <span class="p">]</span> <span class="p">)</span></div>
        <span class="k">return</span> <span class="n">output_mole_fractions</span>

        
<div class="viewcode-block" id="Calculation.mole_fraction_correction"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.Calculation.mole_fraction_correction">[docs]</a>    <span class="k">def</span> <span class="nf">mole_fraction_correction</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">target_mole_fractions</span><span class="p">,</span> <span class="n">approximation</span><span class="p">,</span> <span class="n">initial_guess</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starting from an initial guess for the appropriate input mole fractions, minimises the error between the target bulk mole fraction and the output mole fraction from the iterative Poisson-Boltzmann solver. </span>
<span class="sd">        Args:</span>
<span class="sd">            target_mole_fractions( list ): The value that the mole fractions should be in the bulk. </span>

<span class="sd">        Returns:</span>
<span class="sd">            opt_mole_fractions( list ): The optimum values to be used as the input mole fractions for the iterative Poisson-Boltzmann solver so that the output bulk mole fractions are the target bulk mole fractions. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_guess</span> <span class="o">=</span> <span class="n">initial_guess</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">target_mole_fractions</span><span class="p">)</span>
        <span class="n">target_mole_fractions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">target_mole_fractions</span><span class="p">])</span>
        <span class="n">opt_mole_fractions</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">mole_fraction_error</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_guess</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span>  <span class="n">target_mole_fractions</span><span class="p">,</span> <span class="n">approximation</span> <span class="p">),</span> <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">bounds</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">opt_mole_fractions</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">opt_mole_fractions</span><span class="o">.</span><span class="n">x</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">mf</span> <span class="ow">in</span> <span class="n">target_mole_fractions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mf</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">set_of_sites</span><span class="o">.</span><span class="n">subset</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">):</span>
                    <span class="k">for</span> <span class="n">defect</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">defect_species</span><span class="p">:</span>
                        <span class="n">defect</span><span class="o">.</span><span class="n">mole_fraction</span> <span class="o">=</span> <span class="n">opt_mole_fractions</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">defect</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">defects</span><span class="p">:</span>
                        <span class="n">defect</span><span class="o">.</span><span class="n">mole_fraction</span> <span class="o">=</span> <span class="n">opt_mole_fractions</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_guess</span> <span class="o">=</span> <span class="n">opt_mole_fractions</span><span class="o">.</span><span class="n">x</span>

<div class="viewcode-block" id="Calculation.find_index"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.Calculation.find_index">[docs]</a>    <span class="k">def</span> <span class="nf">find_index</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">min_cut_off</span><span class="p">,</span> <span class="n">max_cut_off</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Calculates the indices of the grid positions closest to a minimum and maximum value.</span>
<span class="sd">        Args:</span>
<span class="sd">	    grid (object): Grid object - contains properties of the grid including the x coordinates and the volumes. Used to access the x coordinates.</span>
<span class="sd">	    min_cut_off (float): Minimum x coordinate value defining the calculation region. </span>
<span class="sd">	    max_cut_off (float): Maximum x coordinate value defining the calculation region.</span>
<span class="sd">	Returns:</span>
<span class="sd">	    min_index (int): Index for minimum cut off.</span>
<span class="sd">	    max_index (int): Index for maximum cut off.</span>

<span class="sd">	&quot;&quot;&quot;</span>
        <span class="n">min_index</span> <span class="o">=</span> <span class="n">bisect_left</span><span class="p">(</span> <span class="n">grid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">min_cut_off</span> <span class="p">)</span>
        <span class="n">max_index</span> <span class="o">=</span> <span class="n">bisect_left</span><span class="p">(</span> <span class="n">grid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">max_cut_off</span> <span class="p">)</span></div>
        <span class="k">return</span> <span class="n">min_index</span><span class="p">,</span> <span class="n">max_index</span>

<div class="viewcode-block" id="Calculation.calculate_offset"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.Calculation.calculate_offset">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_offset</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">min_cut_off</span><span class="p">,</span> <span class="n">max_cut_off</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the offset between the midpoint of the last x coordinate in the calculation region and the x coordinate outside of the calulation region.</span>
<span class="sd">        Args:</span>
<span class="sd">            grid (object): Grid object - contains properties of the grid including the x coordinates and the volumes. Used to access the x coordinates.</span>
<span class="sd">            min_cut_off (float): Minimum x coordinate value defining the calculation region. </span>
<span class="sd">	    max_cut_off (float): Maximum x coordinate value defining the calculation region.</span>
<span class="sd">        Returns:</span>
<span class="sd">            min_offset (float): Offset for the minimum x coordinate.</span>
<span class="sd">	    max_offset (float): Offset fot the maximum x coordinate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
 
        <span class="n">min_index</span><span class="p">,</span> <span class="n">max_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_index</span><span class="p">(</span> <span class="n">grid</span><span class="p">,</span> <span class="n">min_cut_off</span><span class="p">,</span> <span class="n">max_cut_off</span> <span class="p">)</span>
        <span class="n">min_offset</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span> <span class="n">grid</span><span class="o">.</span><span class="n">x</span><span class="p">[</span> <span class="n">min_index</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">-</span> <span class="n">grid</span><span class="o">.</span><span class="n">x</span><span class="p">[</span> <span class="n">min_index</span> <span class="p">]</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="p">(</span> <span class="n">grid</span><span class="o">.</span><span class="n">x</span><span class="p">[</span> <span class="n">min_index</span> <span class="p">]</span> <span class="o">-</span> <span class="n">grid</span><span class="o">.</span><span class="n">x</span><span class="p">[</span> <span class="n">min_index</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">)</span>
        <span class="n">max_offset</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span> <span class="n">grid</span><span class="o">.</span><span class="n">x</span><span class="p">[</span> <span class="n">max_index</span> <span class="p">]</span> <span class="o">-</span> <span class="n">grid</span><span class="o">.</span><span class="n">x</span><span class="p">[</span> <span class="n">max_index</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="p">(</span> <span class="n">grid</span><span class="o">.</span><span class="n">x</span><span class="p">[</span> <span class="n">max_index</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">-</span> <span class="n">grid</span><span class="o">.</span><span class="n">x</span><span class="p">[</span> <span class="n">max_index</span> <span class="o">-</span><span class="mi">2</span> <span class="p">]</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">)</span>
     </div>
        <span class="k">return</span> <span class="n">min_offset</span><span class="p">,</span> <span class="n">max_offset</span>

<div class="viewcode-block" id="Calculation.calculate_delta_x"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.Calculation.calculate_delta_x">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_delta_x</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">min_cut_off</span><span class="p">,</span> <span class="n">max_cut_off</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the distance between the midpoints of each consecutive site. Inserts the calculated distance to the next grid point outside of the calculation region to the first and last position as the delta_x value for the endmost sites. </span>
<span class="sd">        Args:</span>
<span class="sd">            grid (object): Grid object - contains properties of the grid including the x coordinates and the volumes. Used to access the x coordinates.</span>
<span class="sd">            min_cut_off (float): Minimum x coordinate value defining the calculation region. </span>
<span class="sd">	    max_cut_off (float): Maximum x coordinate value defining the calculation region.</span>
<span class="sd">	Returns:</span>
<span class="sd">	    delta_x_from_grid (list): Distance between consecutive sites. </span>
<span class="sd">	&quot;&quot;&quot;</span>
        <span class="n">min_index</span><span class="p">,</span> <span class="n">max_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_index</span><span class="p">(</span> <span class="n">grid</span><span class="p">,</span> <span class="n">min_cut_off</span><span class="p">,</span> <span class="n">max_cut_off</span> <span class="p">)</span>
        <span class="n">min_offset</span><span class="p">,</span> <span class="n">max_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_offset</span><span class="p">(</span> <span class="n">grid</span><span class="p">,</span> <span class="n">min_cut_off</span><span class="p">,</span> <span class="n">max_cut_off</span> <span class="p">)</span></div>
        <span class="k">return</span> <span class="n">delta_x_from_grid</span><span class="p">(</span> <span class="n">grid</span><span class="o">.</span><span class="n">x</span><span class="p">[</span> <span class="n">min_index</span><span class="o">+</span><span class="mi">1</span> <span class="p">:</span> <span class="n">max_index</span> <span class="p">],</span> <span class="p">[</span><span class="n">min_offset</span><span class="p">,</span> <span class="n">max_offset</span><span class="p">]</span> <span class="p">)</span>

<div class="viewcode-block" id="Calculation.calculate_average"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.Calculation.calculate_average">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_average</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">min_cut_off</span><span class="p">,</span> <span class="n">max_cut_off</span><span class="p">,</span> <span class="n">sc_property</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the average of a given space chage property over a given region.</span>
<span class="sd">        Args:</span>
<span class="sd">            grid (object): Grid object - contains properties of the grid including the x coordinates and the volumes. Used to access the x coordinates.</span>
<span class="sd">            min_cut_off (float): Minimum x coordinate value defining the calculation region. </span>
<span class="sd">            max_cut_off (float): Maximum x coordinate value defining the calculation region.</span>
<span class="sd">            sc_property (list): Value of space charge property at all sites.</span>
<span class="sd">        Returns:</span>
<span class="sd">            average_sc_propery (float): The average value for the property over the given sites. </span>
<span class="sd">	&quot;&quot;&quot;</span>
        <span class="n">min_index</span><span class="p">,</span> <span class="n">max_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_index</span><span class="p">(</span> <span class="n">grid</span><span class="p">,</span> <span class="n">min_cut_off</span><span class="p">,</span> <span class="n">max_cut_off</span> <span class="p">)</span>
        <span class="n">delta_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_delta_x</span><span class="p">(</span> <span class="n">grid</span><span class="p">,</span> <span class="n">min_cut_off</span><span class="p">,</span> <span class="n">max_cut_off</span> <span class="p">)</span></div>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">sc_property</span><span class="p">[</span> <span class="n">min_index</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">max_index</span> <span class="p">]</span> <span class="o">*</span> <span class="n">delta_x</span> <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">delta_x</span> <span class="p">)</span>

<div class="viewcode-block" id="Calculation.solve"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.Calculation.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">approximation</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Self-consistent solving of the Poisson-Boltzmann equation. Iterates until the convergence is less than the convergence limit.</span>
<span class="sd">        Args:</span>
<span class="sd">            approximation( str ): Approximation used for the defect behaviour.</span>
<span class="sd">                                  &#39;mott-schottky&#39; - Some defects immobile / fixed to bulk mole fractions.</span>
<span class="sd">                                  &#39;gouy-chapman&#39; - All defects mobile / able to redistribute.</span>
<span class="sd">        Returns:</span>
<span class="sd">            phi (array): Electrostatic potential on a one-dimensional grid. </span>
<span class="sd">            rho (float): Charge density on a one-dimensional grid.</span>
<span class="sd">            niter (int): Number of iterations performed to reach convergence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">poisson_solver</span> <span class="o">=</span> <span class="n">MatrixSolver</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dielectric</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">boundary_conditions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boundary_conditions</span> <span class="p">)</span>

        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x</span> <span class="p">)</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x</span> <span class="p">)</span>

        <span class="n">conv</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">niter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">conv</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span><span class="p">:</span>
            <span class="n">predicted_phi</span><span class="p">,</span> <span class="n">rho</span> <span class="o">=</span> <span class="n">poisson_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span> <span class="n">phi</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">approximation</span> <span class="o">==</span> <span class="s1">&#39;gouy-chapman&#39;</span><span class="p">:</span>
                <span class="n">average_phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_average</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_x_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_x_max</span><span class="p">,</span> <span class="n">predicted_phi</span> <span class="p">)</span>
                <span class="n">predicted_phi</span> <span class="o">-=</span> <span class="n">average_phi</span>
            <span class="k">if</span> <span class="n">approximation</span> <span class="o">==</span> <span class="s1">&#39;mott-schottky&#39;</span><span class="p">:</span>
                <span class="n">vo_predicted_phi</span> <span class="o">=</span> <span class="p">[</span> <span class="n">phi_at_x</span><span class="p">(</span> <span class="n">predicted_phi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">subgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">site_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">x</span> <span class="p">]</span>
                <span class="n">average_vo_predicted_phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_average</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">subgrid</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_x_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_x_max</span><span class="p">,</span> <span class="n">predicted_phi</span> <span class="p">)</span>
                <span class="n">predicted_phi</span> <span class="o">-=</span> <span class="n">average_vo_predicted_phi</span>
            <span class="n">phi</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">predicted_phi</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="p">)</span> <span class="o">*</span> <span class="n">phi</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="p">(</span> <span class="n">predicted_phi</span> <span class="o">-</span> <span class="n">phi</span> <span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x</span> <span class="p">)</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">set_of_sites</span><span class="o">.</span><span class="n">calculate_probabilities</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="p">)</span>
            <span class="n">niter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">niter</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
<span class="c1">#            if niter == 1:</span>
<span class="c1">#                print(conv)</span>
                 <span class="nb">print</span><span class="p">(</span><span class="n">vo_predicted_phi</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                 <span class="nb">print</span><span class="p">(</span><span class="n">average_vo_predicted_phi</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                 <span class="nb">print</span><span class="p">(</span><span class="n">predicted_phi</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#                print(phi, rho)</span>
<span class="c1">#                stop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi</span> <span class="o">=</span> <span class="n">phi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">rho</span><span class="p">(</span> <span class="n">phi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="p">)</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">niter</span> <span class="o">=</span> <span class="n">niter</span>

<div class="viewcode-block" id="Calculation.form_subgrids"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.Calculation.form_subgrids">[docs]</a>    <span class="k">def</span> <span class="nf">form_subgrids</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">site_labels</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a Grid class for each species in the system.</span>
<span class="sd">        Args:</span>
<span class="sd">            site_labels( list ): List of strings for the different site species.</span>
<span class="sd">  </span>
<span class="sd">        Returns:</span>
<span class="sd">            subgrids[name]( dict ): Dictionary of separate Grid classes for the different site species (name). </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site_labels</span> <span class="o">=</span> <span class="n">site_labels</span>
        <span class="n">subgrids</span> <span class="o">=</span> <span class="p">{}</span> 
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">site_labels</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">label</span> <span class="p">)</span> 
            <span class="n">subgrids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">subgrid</span><span class="p">(</span> <span class="n">label</span> <span class="p">)</span>
            <span class="n">subgrids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">delta_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">subgrids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">delta_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">subgrids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">delta_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">subgrids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">delta_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">subgrids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">volumes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">subgrids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">volumes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">subgrids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">volumes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">subgrids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">volumes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">subgrids</span> <span class="o">=</span> <span class="n">subgrids</span>

<div class="viewcode-block" id="Calculation.create_subregion_sites"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.Calculation.create_subregion_sites">[docs]</a>    <span class="k">def</span> <span class="nf">create_subregion_sites</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">min_cut_off</span><span class="p">,</span> <span class="n">max_cut_off</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a Set_of_Sites object for a defined region of the grid.</span>
<span class="sd">        Args:</span>
<span class="sd">            grid (object): Grid object - contains properties of the grid including the x coordinates and the volumes. Used to access the x coordinates.</span>
<span class="sd">            min_cut_off (float): Minimum x coordinate value defining the calculation region. </span>
<span class="sd">            max_cut_off (float): Maximum x coordinate value defining the calculation region.</span>
<span class="sd">        Returns:</span>
<span class="sd">            sites (object): Set of Sites object for a given subregion of the grid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">set_of_sites</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">site</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">min_cut_off</span> <span class="ow">and</span> <span class="n">site</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">max_cut_off</span><span class="p">:</span>
                <span class="n">sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">site</span> <span class="p">)</span>
        <span class="n">sites</span> <span class="o">=</span> <span class="n">Set_of_Sites</span><span class="p">(</span> <span class="n">sites</span> <span class="p">)</span></div>
        <span class="k">return</span> <span class="n">sites</span>

<div class="viewcode-block" id="Calculation.create_space_charge_region"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.Calculation.create_space_charge_region">[docs]</a>    <span class="k">def</span> <span class="nf">create_space_charge_region</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">pos_or_neg_scr</span><span class="p">,</span> <span class="n">scr_limit</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Finds the space charge region. The space charge region is defined as the region when the electrostatic potential is greater than a predefined limit.</span>
<span class="sd">	Args:</span>
<span class="sd">	    grid (object): Grid object - contains properties of the grid including the x coordinates and the volumes. Used to access the x coordinates.</span>
<span class="sd">	    pos_or_neg_scr (str): &#39;positive&#39; - for a positive space charge potential.</span>
<span class="sd">				  &#39;negative&#39; - for a negative space charge potential.</span>
<span class="sd">	    scr_limit (float): The minimum electrostatic potential that the electrostatic potential must exceed to be included in the space charge region.</span>
<span class="sd">	Returns:</span>
<span class="sd">	    space_charge_region (list): List of x coordinates for sites within the space charge region.</span>
<span class="sd">	&quot;&quot;&quot;</span>	
        <span class="n">space_charge_region</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi_on_mobile_defect_grid</span> <span class="o">=</span> <span class="p">[</span> <span class="n">phi_at_x</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">x</span> <span class="p">]</span> 
        <span class="n">x_and_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span> <span class="p">(</span> <span class="n">grid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_on_mobile_defect_grid</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">x_and_phi</span> <span class="p">)</span> <span class="p">):</span>
            <span class="k">if</span> <span class="n">pos_or_neg_scr</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x_and_phi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x_and_phi</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">scr_limit</span><span class="p">:</span>
                    <span class="n">space_charge_region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">x_and_phi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">pos_or_neg_scr</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">x_and_phi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x_and_phi</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">scr_limit</span><span class="p">:</span>
                    <span class="n">space_charge_region</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">x_and_phi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span></div>
        <span class="k">return</span> <span class="n">space_charge_region</span>

<div class="viewcode-block" id="Calculation.calculate_mobile_defect_conductivities"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.Calculation.calculate_mobile_defect_conductivities">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_mobile_defect_conductivities</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">pos_or_neg_scr</span><span class="p">,</span> <span class="n">scr_limit</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">mobility_scaling</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the conductivity ratio between the space charge region and the bulk both perpendicular and parallel to the grain boundary.</span>
<span class="sd">        A Set_of_Sites object is created for the sites in the space charge region, and the defect distributions calculated. The width of the space charge region is calculated and a bulk region of the same width is defined. A Set_of_Sites object for the bulk region is created and the defect distributions calculated. Taking each site as a resistor in series or parallel respectively, the conductivity is calculated and the ratio between the space charge region and the bulk is taken. </span>
<span class="sd">        Args:</span>
<span class="sd">            pos_or_neg_scr (str): &#39;positive&#39; - for a positive space charge potential.</span>
<span class="sd">				  &#39;negative&#39; - for a negative space charge potential.</span>
<span class="sd">            scr_limit (float): The minimum electrostatic potential that the electrostatic potential must exceed to be included in the space charge region.</span>
<span class="sd">            species (str): The species for which the conductivity is being calculated.</span>
<span class="sd">            mobility_scaling (bool): For particles on a lattice which only interact through volume exclusion, the mobility exhibits a blocking term. True if the blocking term is to be included, False if the blocking term is not to be included. Default = False.</span>
<span class="sd">        Returns:</span>
<span class="sd">            perpendicular_conductivity_ratio (float): The conductivity ratio between the bulk and the space charge region perpendicular to the grain boundary.</span>
<span class="sd">            parallel_conductivity_ratio (float): The conductivity ratio between the bulk and the space charge region parallel to the grain boundary. </span>
<span class="sd">	&quot;&quot;&quot;</span>
        <span class="n">space_charge_region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_space_charge_region</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgrids</span><span class="p">[</span><span class="n">species</span><span class="p">],</span> <span class="n">pos_or_neg_scr</span><span class="p">,</span> <span class="n">scr_limit</span> <span class="p">)</span>
        <span class="n">space_charge_region_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_offset</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgrids</span><span class="p">[</span><span class="n">species</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">space_charge_region</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">space_charge_region</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">space_charge_region_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subregion_sites</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgrids</span><span class="p">[</span><span class="n">species</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">space_charge_region</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">space_charge_region</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">space_charge_region_sites</span><span class="p">:</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">site</span><span class="o">.</span><span class="n">defects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">valence</span>
            <span class="n">mobilities</span> <span class="o">=</span> <span class="n">site</span><span class="o">.</span><span class="n">defects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mobility</span>
        <span class="n">space_charge_region_grid</span> <span class="o">=</span> <span class="n">Grid</span><span class="o">.</span><span class="n">grid_from_set_of_sites</span><span class="p">(</span> <span class="n">space_charge_region_sites</span><span class="p">,</span> <span class="n">space_charge_region_limits</span><span class="p">,</span> <span class="n">space_charge_region_limits</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">c</span> <span class="p">)</span>
        <span class="n">space_charge_region_width</span> <span class="o">=</span> <span class="n">space_charge_region_grid</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">space_charge_region_grid</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mobile_defect_density</span> <span class="o">=</span> <span class="n">Set_of_Sites</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgrids</span><span class="p">[</span><span class="n">species</span><span class="p">]</span><span class="o">.</span><span class="n">set_of_sites</span> <span class="p">)</span><span class="o">.</span><span class="n">subgrid_calculate_defect_density</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgrids</span><span class="p">[</span><span class="n">species</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="p">)</span>
        <span class="n">space_charge_region_mobile_defect_mf</span> <span class="o">=</span> <span class="n">space_charge_region_sites</span><span class="o">.</span><span class="n">calculate_probabilities</span><span class="p">(</span> <span class="n">space_charge_region_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="p">)</span>
        <span class="n">space_charge_region_mobile_defect_density</span> <span class="o">=</span> <span class="n">space_charge_region_sites</span><span class="o">.</span><span class="n">subgrid_calculate_defect_density</span><span class="p">(</span> <span class="n">space_charge_region_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">mobility_scaling</span><span class="p">:</span>
             <span class="n">mobile_defect_conductivity</span> <span class="o">=</span> <span class="n">space_charge_region_mobile_defect_density</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">space_charge_region_mobile_defect_mf</span> <span class="p">)</span> <span class="o">*</span> <span class="n">charge</span> <span class="o">*</span> <span class="n">mobilities</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mobile_defect_conductivity</span> <span class="o">=</span> <span class="n">space_charge_region_mobile_defect_density</span> <span class="o">*</span> <span class="n">charge</span> <span class="o">*</span> <span class="n">mobilities</span>
        <span class="n">bulk_x_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_x_min</span> <span class="o">+</span> <span class="n">space_charge_region_width</span>
        <span class="n">min_bulk_index</span><span class="p">,</span> <span class="n">max_bulk_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_index</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgrids</span><span class="p">[</span><span class="n">species</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_x_min</span><span class="p">,</span> <span class="n">bulk_x_max</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bulk_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_offset</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgrids</span><span class="p">[</span><span class="n">species</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_x_min</span><span class="p">,</span> <span class="n">bulk_x_max</span> <span class="p">)</span> 
        <span class="n">bulk_mobile_defect_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subregion_sites</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgrids</span><span class="p">[</span><span class="n">species</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_x_min</span><span class="p">,</span> <span class="n">bulk_x_max</span> <span class="p">)</span>
        <span class="n">bulk_mobile_defect_grid</span> <span class="o">=</span> <span class="n">Grid</span><span class="o">.</span><span class="n">grid_from_set_of_sites</span><span class="p">(</span> <span class="n">bulk_mobile_defect_sites</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_limits</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bulk_limits</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">c</span> <span class="p">)</span>
        <span class="n">bulk_mobile_defect_density</span> <span class="o">=</span> <span class="n">Set_of_Sites</span><span class="p">(</span> <span class="n">bulk_mobile_defect_grid</span><span class="o">.</span><span class="n">set_of_sites</span> <span class="p">)</span><span class="o">.</span><span class="n">subgrid_calculate_defect_density</span><span class="p">(</span> <span class="n">bulk_mobile_defect_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="p">)</span>  
        <span class="n">bulk_region_mobile_defect_mf</span> <span class="o">=</span> <span class="n">bulk_mobile_defect_sites</span><span class="o">.</span><span class="n">calculate_probabilities</span><span class="p">(</span> <span class="n">bulk_mobile_defect_grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">mobility_scaling</span><span class="p">:</span>
            <span class="n">bulk_mobile_defect_conductivity</span> <span class="o">=</span> <span class="n">bulk_mobile_defect_density</span> <span class="o">*</span> <span class="n">charge</span> <span class="o">*</span> <span class="n">mobilities</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bulk_mobile_defect_conductivity</span> <span class="o">=</span> <span class="n">bulk_mobile_defect_density</span> <span class="o">*</span> <span class="n">charge</span> <span class="o">*</span> <span class="n">mobilities</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">bulk_region_mobile_defect_mf</span><span class="p">)</span>
        <span class="n">space_charge_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span> <span class="p">(</span> <span class="n">mobile_defect_conductivity</span><span class="p">,</span> <span class="n">space_charge_region_grid</span><span class="o">.</span><span class="n">x</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">bulk_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span> <span class="p">(</span> <span class="n">bulk_mobile_defect_conductivity</span><span class="p">,</span> <span class="n">bulk_mobile_defect_grid</span><span class="o">.</span><span class="n">x</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">mobilities</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">space_charge_perpendicular</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">space_charge_region_grid</span><span class="o">.</span><span class="n">delta_x</span> <span class="o">/</span> <span class="n">mobile_defect_conductivity</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">average_bulk_mobile_defect_density</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">bulk_mobile_defect_grid</span><span class="o">.</span><span class="n">delta_x</span> <span class="o">*</span> <span class="n">bulk_mobile_defect_density</span> <span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">bulk_mobile_defect_grid</span><span class="o">.</span><span class="n">delta_x</span><span class="p">)</span>
            <span class="n">bulk_perpendicular</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">bulk_mobile_defect_conductivity</span> <span class="o">/</span> <span class="n">bulk_mobile_defect_grid</span><span class="o">.</span><span class="n">delta_x</span> <span class="p">)</span>
            <span class="n">space_charge_parallel</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">mobile_defect_conductivity</span> <span class="o">/</span> <span class="n">space_charge_region_grid</span><span class="o">.</span><span class="n">delta_x</span> <span class="p">)</span>
            <span class="n">bulk_parallel</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">bulk_mobile_defect_grid</span><span class="o">.</span><span class="n">delta_x</span> <span class="o">/</span> <span class="n">bulk_mobile_defect_conductivity</span> <span class="p">)</span>
            <span class="n">perpendicular_conductivity_ratio</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span> <span class="n">space_charge_perpendicular</span> <span class="o">*</span> <span class="n">bulk_perpendicular</span> <span class="p">)</span>
            <span class="n">parallel_conductivity_ratio</span> <span class="o">=</span> <span class="n">space_charge_parallel</span> <span class="o">*</span> <span class="n">bulk_parallel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perpendicular_conductivity_ratio</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">parallel_conductivity_ratio</span> <span class="o">=</span> <span class="mf">0.0</span> 
<span class="c1">#        self.depletion_factor = 1 - ( mobile_defect_density / average_bulk )</span></div>
        <span class="k">return</span> <span class="n">perpendicular_conductivity_ratio</span><span class="p">,</span> <span class="n">parallel_conductivity_ratio</span>

<div class="viewcode-block" id="Calculation.calculate_resistivity_ratio"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.Calculation.calculate_resistivity_ratio">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_resistivity_ratio</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">pos_or_neg_scr</span><span class="p">,</span> <span class="n">scr_limit</span><span class="p">,</span> <span class="n">mobility_scaling</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Each species present in the system is looped over and the perpendicular and parallel conductivity ratios are calculated and appended to separate lists. Once all species have been added to the list, the conductivities are summed and the reciprocal taken to give the resistivity ratios perpendicular and parallel to the grain boundary.</span>
<span class="sd">        Args:</span>
<span class="sd">            pos_or_neg_scr (str): &#39;positive&#39; - for a positive space charge potential.</span>
<span class="sd">				  &#39;negative&#39; - for a negative space charge potential.</span>
<span class="sd">            scr_limit (float): The minimum electrostatic potential that the electrostatic potential must exceed to be included in the space charge region.</span>
<span class="sd">            mobility_scaling (bool): For particles on a lattice which only interact through volume exclusion, the mobility exhibits a blocking term. True if the blocking term is to be included, False if the blocking term is not to be included. Default = False.</span>
<span class="sd">        Returns:</span>
<span class="sd">            perpendicular_resistivity_ratio (float): The resistivity ratio between the bulk and the space charge region perpendicular to the grain boundary.</span>
<span class="sd">            parallel_resistivity_ratio (float): The resistivity ratio between the bulk and the space charge region parallel to the grain boundary. </span>
<span class="sd">	&quot;&quot;&quot;</span>
        <span class="n">full_parallel_conductivity_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">full_perpendicular_conductivity_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_labels</span><span class="p">:</span>
            <span class="n">c_per</span><span class="p">,</span> <span class="n">c_par</span> <span class="o">=</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_mobile_defect_conductivities</span><span class="p">(</span> <span class="n">pos_or_neg_scr</span><span class="p">,</span> <span class="n">scr_limit</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">mobility_scaling</span>  <span class="p">))</span>
            <span class="n">full_parallel_conductivity_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_par</span><span class="p">)</span>
            <span class="n">full_perpendicular_conductivity_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c_per</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perpendicular_resistivity_ratio</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">full_perpendicular_conductivity_data</span><span class="p">)</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel_resistivity_ratio</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">full_parallel_conductivity_data</span><span class="p">)</span>
            
<div class="viewcode-block" id="Calculation.solve_MS_approx_for_phi"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.Calculation.solve_MS_approx_for_phi">[docs]</a>    <span class="k">def</span> <span class="nf">solve_MS_approx_for_phi</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">valence</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Using the calculated resistivity ratio, solves the Mott-Schottky model to calculate the space charge potential (analogous to experimental analysis).</span>
<span class="sd">        If the resistivity ratio calculated is less that 1.36, ValueError raised as solution to the Mott-Schottky model is not on a real branch.</span>
<span class="sd">        Args:</span>
<span class="sd">            valence( float ): Charge of species at site. </span>
<span class="sd">   </span>
<span class="sd">        Returns:</span>
<span class="sd">            ms_phi( float ): Space charge potential calculated from Mott-Schottky model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perpendicular_resistivity_ratio</span> <span class="o">&lt;</span> <span class="mf">1.36</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;Resistivity ratio &lt; 1.36. Solution not on a real branch.&quot;</span> <span class="p">)</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms_phi</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">mpmath</span><span class="o">.</span><span class="n">lambertw</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">perpendicular_resistivity_ratio</span><span class="p">),</span><span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span> <span class="n">boltzmann_eV</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="p">)</span> <span class="o">/</span> <span class="n">valence</span> <span class="p">)</span>

<div class="viewcode-block" id="Calculation.calculate_debye_length"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.Calculation.calculate_debye_length">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_debye_length</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            debye_length( float ): Debye length as derived from Poisson-Boltzmann equation</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">debye_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">dielectric</span> <span class="o">*</span> <span class="n">vacuum_permittivity</span> <span class="o">*</span> <span class="n">boltzmann_eV</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span> <span class="n">fundamental_charge</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_bulk_mobile_defect_density</span> <span class="p">)</span> <span class="p">)</span>

<div class="viewcode-block" id="Calculation.calculate_space_charge_width"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.Calculation.calculate_space_charge_width">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_space_charge_width</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">valence</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the approximate space charge width from the debye length.</span>
<span class="sd">        Args:</span>
<span class="sd">	    valence (float): The charge of the mobile defect species.</span>
<span class="sd">        Returns:</span>
<span class="sd">            space_charge_width( float ): Approximate space charge width.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">space_charge_width</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">debye_length</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="p">(</span> <span class="n">boltzmann_eV</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="p">)</span> <span class="o">/</span> <span class="n">valence</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>


<div class="viewcode-block" id="Calculation.mole_fractions"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.Calculation.mole_fractions">[docs]</a>    <span class="k">def</span> <span class="nf">mole_fractions</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the mole fractions (probability of defects occupation ) for each site on the subgrid for each species.</span>
<span class="sd"> </span>
<span class="sd">        Returns:</span>
<span class="sd">            mf( dict ): A dictionary of the defect species mole fractions for each site on the subgrid for each site species. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mole_fractions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_labels</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">mole_fractions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Set_of_Sites</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subgrids</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">set_of_sites</span><span class="p">)</span><span class="o">.</span><span class="n">calculate_probabilities</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="p">)</span></div></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">mf</span> <span class="o">=</span> <span class="n">mole_fractions</span>


<div class="viewcode-block" id="diff_central"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.diff_central">[docs]</a><span class="k">def</span> <span class="nf">diff_central</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the numerical derivative of x,y data using a central difference approximation.</span>
<span class="sd">   </span>
<span class="sd">    Args:</span>
<span class="sd">        x, y (array): x,y data to be differentiated.     </span>
<span class="sd">    Returns:</span>
<span class="sd">        (array): numerical derivative of x,y</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span></div>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="o">*</span><span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> 

<div class="viewcode-block" id="calculate_activation_energies"><a class="viewcode-back" href="../../pyscses.html#pyscses.calculation.calculate_activation_energies">[docs]</a><span class="k">def</span> <span class="nf">calculate_activation_energies</span><span class="p">(</span> <span class="n">ratios</span><span class="p">,</span> <span class="n">temp</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solves the Arrhenius equation using the calculated resistivity ratio for a series of temperatures to calculate the activation energy for single defect segregation.</span>
<span class="sd">    Uses a central difference approach so endpoints filled in with NaN to create an array with the same length as the args.</span>
<span class="sd">   </span>
<span class="sd">    Args:</span>
<span class="sd">        ratios( list ): Resistivity ratios calculated for a range of temperatures.</span>
<span class="sd">        temp( list ): Temperature (values used to calculate resistivity ratio values).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Ea2( np.array ): The activation energy calculated for different temperatures.  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">temp</span> <span class="p">)</span>
    <span class="n">ratios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ratios</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">temp</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">ratios</span> <span class="p">)</span>
    <span class="n">slopes</span> <span class="o">=</span> <span class="n">diff_central</span><span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">)</span>
    <span class="n">Ea</span> <span class="o">=</span> <span class="n">slopes</span><span class="o">*-</span><span class="n">boltzmann_eV</span>
    <span class="n">Ea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">Ea</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="n">Ea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="n">Ea</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="n">Ea2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Ea</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">Ea</span> <span class="p">)</span></div>
    <span class="k">return</span> <span class="n">Ea2</span>           
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Georgina Wellock.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>